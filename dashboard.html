<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentLink // Multi-AI Consensus Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

        :root {
            --neon-cyan: #00ffff;
            --neon-pink: #ff006e;
            --neon-yellow: #ffbe0b;
            --neon-green: #39ff14;
            --neon-purple: #b967ff;
            --bg-dark: #0a0e27;
            --bg-panel: #111827;
            --text-gray: #94a3b8;
            --border-color: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--text-gray);
            font-family: 'Share Tech Mono', monospace;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridScroll 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridScroll {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .wallet-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .wallet-btn {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .wallet-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .wallet-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wallet-info {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-green);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--neon-green);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid var(--neon-green);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: var(--neon-green);
            text-transform: uppercase;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: var(--neon-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--neon-green); }
            50% { opacity: 0.3; box-shadow: 0 0 5px var(--neon-green); }
        }

        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-cyan);
        }

        /* Request Panel */
        .request-panel {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .request-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--neon-cyan);
            text-transform: uppercase;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: stretch;
        }

        .token-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            color: var(--neon-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s;
            outline: none;
        }

        .token-input:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .analyze-btn {
            background: linear-gradient(135deg, var(--neon-green), var(--neon-cyan));
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.5);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #333;
        }

        .price-info {
            text-align: center;
            color: var(--text-gray);
            font-size: 13px;
            margin-top: 10px;
        }

        .price-amount {
            color: var(--neon-yellow);
            font-weight: bold;
        }

        .quick-tokens {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-token-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            color: var(--text-gray);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .quick-token-btn:hover {
            border-color: var(--neon-purple);
            color: var(--neon-purple);
            background: rgba(185, 103, 255, 0.1);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .consensus-display {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .consensus-signal {
            font-size: 48px;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite;
        }

        .signal-BUY { color: var(--neon-green); text-shadow: 0 0 20px var(--neon-green); }
        .signal-SELL { color: var(--neon-pink); text-shadow: 0 0 20px var(--neon-pink); }
        .signal-HOLD { color: var(--neon-yellow); text-shadow: 0 0 20px var(--neon-yellow); }

        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .consensus-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 10px;
        }

        .consensus-stat {
            flex: 1;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border-left: 3px solid var(--neon-cyan);
        }

        .consensus-stat-label {
            font-size: 10px;
            color: var(--text-gray);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .consensus-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--neon-cyan);
        }

        .ai-models {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-model {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .ai-model:hover {
            border-color: var(--neon-purple);
            box-shadow: 0 0 15px rgba(185, 103, 255, 0.3);
            transform: translateX(5px);
        }

        .ai-model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ai-model-name {
            font-weight: bold;
            color: var(--neon-purple);
            font-size: 14px;
        }

        .ai-model-badge {
            background: rgba(185, 103, 255, 0.2);
            color: var(--neon-purple);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .ai-model-signal {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .signal-indicator {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .signal-indicator.BUY { background: rgba(57, 255, 20, 0.2); color: var(--neon-green); }
        .signal-indicator.SELL { background: rgba(255, 0, 110, 0.2); color: var(--neon-pink); }
        .signal-indicator.HOLD { background: rgba(255, 190, 11, 0.2); color: var(--neon-yellow); }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 4px;
            transition: width 1s ease;
        }

        .ai-model-reason {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 8px;
            font-style: italic;
        }

        .analysis-summary {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--neon-cyan);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-gray);
        }

        .log-feed {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .log-feed::-webkit-scrollbar {
            width: 6px;
        }

        .log-feed::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .log-feed::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 10px;
        }

        .log-entry {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--border-color);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .log-entry:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateX(5px);
        }

        .log-entry.PAID { border-left-color: var(--neon-green); }
        .log-entry.BLOCK { border-left-color: var(--neon-yellow); }
        .log-entry.ERROR { border-left-color: var(--neon-pink); }
        .log-entry.AI { border-left-color: var(--neon-purple); }
        .log-entry.DATA { border-left-color: var(--neon-cyan); }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .log-type {
            font-weight: bold;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .log-time {
            font-size: 10px;
            color: #666;
        }

        .log-message {
            font-size: 13px;
            color: var(--text-gray);
        }

        .market-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .market-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .market-stat-label {
            font-size: 11px;
            color: var(--text-gray);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .market-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--neon-cyan);
            font-family: 'Orbitron', sans-serif;
        }

        .price-change {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .price-change.positive {
            background: rgba(57, 255, 20, 0.2);
            color: var(--neon-green);
        }

        .price-change.negative {
            background: rgba(255, 0, 110, 0.2);
            color: var(--neon-pink);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 11px;
            margin-top: 30px;
        }

        .footer-link {
            color: var(--neon-cyan);
            text-decoration: none;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(17, 24, 39, 0.95);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            padding: 15px 20px;
            color: var(--neon-cyan);
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { border-color: var(--neon-green); color: var(--neon-green); }
        .notification.error { border-color: var(--neon-pink); color: var(--neon-pink); }
        .notification.warning { border-color: var(--neon-yellow); color: var(--neon-yellow); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-top">
                <div>
                    <h1>‚ö° AgentLink</h1>
                    <p style="color: var(--text-gray); margin-top: 5px; font-size: 12px;">
                        Multi-Round AI Consensus Engine ‚Ä¢ HTTP 402 Protocol ‚Ä¢ Cronos Testnet
                    </p>
                </div>
                <div class="wallet-section">
                    <button class="wallet-btn" id="connectBtn" onclick="connectWallet()">
                        Connect Wallet
                    </button>
                    <div class="wallet-info" id="walletInfo" style="display: none;">
                        <div id="walletAddress">0x0000...0000</div>
                        <div id="walletBalance" style="margin-top: 5px;">0.00 USDC</div>
                    </div>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-box">
                    <div class="stat-label">Total Analyses</div>
                    <div class="stat-value" id="total-analyses">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Active AI Models</div>
                    <div class="stat-value">2</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Consensus Rounds</div>
                    <div class="stat-value">2</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Revenue Collected</div>
                    <div class="stat-value" id="total-revenue">0.00 USDC</div>
                </div>
            </div>
        </header>

        <!-- Request Panel -->
        <div class="request-panel">
            <h2 class="request-title">üéØ Request AI Consensus Analysis</h2>
            <div class="input-group">
                <input 
                    type="text" 
                    class="token-input" 
                    id="tokenInput" 
                    placeholder="Enter Token (e.g., BTC, ETH, CRO)"
                    maxlength="10"
                />
                <button class="analyze-btn" id="analyzeBtn" onclick="requestAnalysis()" disabled>
                    Analyze Token
                </button>
            </div>
            <div class="quick-tokens">
                <button class="quick-token-btn" onclick="setToken('BTC')">BTC</button>
                <button class="quick-token-btn" onclick="setToken('ETH')">ETH</button>
                <button class="quick-token-btn" onclick="setToken('CRO')">CRO</button>
                <button class="quick-token-btn" onclick="setToken('SOL')">SOL</button>
                <button class="quick-token-btn" onclick="setToken('BNB')">BNB</button>
                <button class="quick-token-btn" onclick="setToken('PEPE')">PEPE</button>
            </div>
            <div class="price-info">
                Price per analysis: <span class="price-amount">0.01 USDC</span> ‚Ä¢ 
                Includes 2 AI models in 2 rounds of deliberation
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Column -->
            <div>
                <div class="panel" id="consensus-panel" style="display: none;">
                    <div class="panel-header">
                        <h2 class="panel-title">üéØ Latest Consensus</h2>
                        <span id="consensus-token" style="color: var(--neon-yellow); font-weight: bold; font-size: 20px;">---</span>
                    </div>
                    
                    <div class="consensus-display">
                        <div class="consensus-signal" id="consensus-signal">WAITING</div>
                        <div style="font-size: 14px; color: var(--text-gray); margin-bottom: 15px;" id="consensus-summary">
                            Awaiting first analysis...
                        </div>
                        <div class="consensus-stats">
                            <div class="consensus-stat">
                                <div class="consensus-stat-label">Agreement</div>
                                <div class="consensus-stat-value" id="consensus-agreement">--%</div>
                            </div>
                            <div class="consensus-stat">
                                <div class="consensus-stat-label">Confidence</div>
                                <div class="consensus-stat-value" id="consensus-confidence">--%</div>
                            </div>
                            <div class="consensus-stat">
                                <div class="consensus-stat-label">Rounds</div>
                                <div class="consensus-stat-value" id="consensus-rounds">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-summary" id="analysis-detail">
                        <strong style="color: var(--neon-cyan);">üìù Analysis Summary:</strong><br>
                        <span id="analysis-text">Waiting for consensus data...</span>
                    </div>

                    <div class="market-data" style="margin-top: 20px;">
                        <div class="market-stat">
                            <div class="market-stat-label">Current Price</div>
                            <div class="market-stat-value" id="market-price">$--</div>
                        </div>
                        <div class="market-stat">
                            <div class="market-stat-label">24h Change</div>
                            <div class="market-stat-value" id="market-change">
                                <span id="change-value">--%</span>
                            </div>
                        </div>
                        <div class="market-stat">
                            <div class="market-stat-label">Volume</div>
                            <div class="market-stat-value" id="market-volume">$--</div>
                        </div>
                    </div>
                </div>

                <div class="panel" id="waiting-panel">
                    <div class="loading">
                        <div style="font-size: 48px; margin-bottom: 20px;">ü§ñ</div>
                        <div style="font-size: 18px; color: var(--neon-cyan); margin-bottom: 10px;">
                            AWAITING FIRST REQUEST
                        </div>
                        <div style="font-size: 12px;">
                            Multi-Round AI Consensus Engine Ready
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div>
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">ü§ñ AI Council</h2>
                    </div>
                    <div class="ai-models" id="ai-models">
                        <div class="ai-model">
                            <div class="ai-model-header">
                                <span class="ai-model-name">üß† Llama 3.3 70B Strategist</span>
                                <span class="ai-model-badge">Deep Analysis</span>
                            </div>
                            <div class="ai-model-signal">
                                <span class="signal-indicator HOLD">STANDBY</span>
                                <span style="font-size: 12px; color: var(--text-gray);">Long-term Perspective</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 0%"></div>
                            </div>
                            <div class="ai-model-reason">Waiting for market data...</div>
                        </div>

                        <div class="ai-model">
                            <div class="ai-model-header">
                                <span class="ai-model-name">‚ö° Llama 3.1 8B Tactician</span>
                                <span class="ai-model-badge">Rapid Assessment</span>
                            </div>
                            <div class="ai-model-signal">
                                <span class="signal-indicator HOLD">STANDBY</span>
                                <span style="font-size: 12px; color: var(--text-gray);">Short-term Perspective</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 0%"></div>
                            </div>
                            <div class="ai-model-reason">Waiting for market data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">üìä Activity Log</h2>
                <span style="font-size: 11px; color: var(--text-gray);">Real-time system events</span>
            </div>
            <div class="log-feed" id="logs">
                <div class="loading">Monitoring system activity...</div>
            </div>
        </div>

        <footer>
            AgentLink v1.0 ‚Ä¢ Multi-Round AI Consensus Engine<br>
            Built for <a href="#" class="footer-link">Cronos x402 Paytech Hackathon</a> ‚Ä¢ 
            Powered by Groq AI & Cronos Blockchain
        </footer>
    </div>

    <script>
        // Constants
        const API_URL = 'http://localhost:3000';
        const CRONOS_TESTNET_CHAIN_ID = '0x152'; // 338 in hex
        const DEV_USDC_ADDRESS = '0xc01efAaF7C5C61bEbFAeb358E1161b537b8bC0e0';
        const SELLER_WALLET = '0x706f61089d8a9c1aaa3b80e8caa6f38853f7abf3';
        const PRICE_UNITS = '10000'; // 0.01 USDC (6 decimals)

        // State
        let provider = null;
        let signer = null;
        let userAddress = null;
        let totalAnalyses = 0;
        let latestToken = 'BTC';
        let latestPrice = null;

        // ABI for ERC-20 transfer
        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) returns (bool)',
            'function balanceOf(address owner) view returns (uint256)',
            'function approve(address spender, uint256 amount) returns (bool)'
        ];

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Connect Wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showNotification('Please install MetaMask!', 'error');
                return;
            }

            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                // Create provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== 338) {
                    await switchToCronosTestnet();
                }

                // Get USDC balance
                await updateWalletUI();

                showNotification('Wallet connected successfully!', 'success');

                // Enable analyze button
                document.getElementById('analyzeBtn').disabled = false;

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showNotification('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Switch to Cronos Testnet
        async function switchToCronosTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: CRONOS_TESTNET_CHAIN_ID }],
                });
            } catch (switchError) {
                // Chain doesn't exist, add it
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: CRONOS_TESTNET_CHAIN_ID,
                            chainName: 'Cronos Testnet',
                            nativeCurrency: { name: 'TCRO', symbol: 'TCRO', decimals: 18 },
                            rpcUrls: ['https://evm-t3.cronos.org'],
                            blockExplorerUrls: ['https://explorer.cronos.org/testnet']
                        }]
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // Update wallet UI
        async function updateWalletUI() {
            if (!userAddress) return;

            // Show wallet info
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('walletInfo').style.display = 'block';
            document.getElementById('walletAddress').textContent = 
                userAddress.slice(0, 6) + '...' + userAddress.slice(-4);

            // Get USDC balance
            try {
                const usdcContract = new ethers.Contract(DEV_USDC_ADDRESS, ERC20_ABI, provider);
                const balance = await usdcContract.balanceOf(userAddress);
                const formattedBalance = ethers.utils.formatUnits(balance, 6);
                document.getElementById('walletBalance').textContent = `${parseFloat(formattedBalance).toFixed(2)} USDC`;
            } catch (error) {
                console.error('Error getting balance:', error);
                document.getElementById('walletBalance').textContent = '0.00 USDC';
            }
        }

        // Set token from quick buttons
        function setToken(token) {
            document.getElementById('tokenInput').value = token;
        }

        // Request Analysis
        async function requestAnalysis() {
            const token = document.getElementById('tokenInput').value.trim().toUpperCase();
            
            if (!token) {
                showNotification('Please enter a token symbol', 'warning');
                return;
            }

            if (!signer) {
                showNotification('Please connect your wallet first', 'warning');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Processing...';

            try {
                // Step 1: Request analysis (expect 402)
                showNotification(`Requesting analysis for ${token}...`, 'success');
                
                let response = await fetch(`${API_URL}/api/analyze/${token}`);
                
                if (response.status === 402) {
                    showNotification('Payment required. Initiating transfer...', 'warning');
                    
                    // Step 2: Pay with USDC
                    const usdcContract = new ethers.Contract(DEV_USDC_ADDRESS, ERC20_ABI, signer);
                    
                    showNotification('Please confirm the transaction in MetaMask...', 'warning');
                    const tx = await usdcContract.transfer(SELLER_WALLET, PRICE_UNITS);
                    
                    showNotification('Transaction sent! Waiting for confirmation...', 'success');
                    const receipt = await tx.wait();
                    
                    showNotification('Payment confirmed! Requesting analysis...', 'success');
                    
                    // Step 3: Retry with payment proof
        response = await fetch(`${API_URL}/api/analyze/${token}`, {
                 headers: {
                        'x-payment-hash': receipt.transactionHash,
                        'x-user-address': userAddress  // ADD THIS LINE
    }
});
                    
                    if (response.ok) {
                        const data = await response.json();
                        showNotification(`‚úÖ Analysis complete for ${token}!`, 'success');
                        
                        // Update wallet balance
                        await updateWalletUI();
                    } else {
                        throw new Error('Analysis request failed after payment');
                    }
                } else if (response.ok) {
                    showNotification(`‚úÖ Analysis complete for ${token}!`, 'success');
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }

            } catch (error) {
                console.error('Error:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Token';
            }
        }

        // Extract token from logs
        function extractTokenFromLogs(logs) {
            for (let i = 0; i < logs.length; i++) {
                const log = logs[i];
                
                if (log.message.includes('FETCHING MARKET DATA FOR')) {
                    const match = log.message.match(/FOR\s+(\w+)/i);
                    if (match) return match[1].toUpperCase();
                }
                
                if (log.type === 'DATA' && log.message.includes('Fetching')) {
                    const match = log.message.match(/Fetching\s+(\w+)/i);
                    if (match) return match[1].toUpperCase();
                }
            }
            
            return latestToken;
        }

        // Extract price from logs
        function extractPriceFromLogs(logs) {
            for (let i = 0; i < logs.length; i++) {
                const log = logs[i];
                
                if (log.type === 'DATA' && log.message.includes('=')) {
                    const match = log.message.match(/=\s*\$(\d+(?:,\d{3})*(?:\.\d{2})?)/);
                    if (match) return parseFloat(match[1].replace(/,/g, ''));
                }
                
                if (log.message.includes('Data acquired') || log.message.includes('‚úÖ')) {
                    const match = log.message.match(/\$(\d+(?:,\d{3})*(?:\.\d{2})?)/);
                    if (match) return parseFloat(match[1].replace(/,/g, ''));
                }
            }
            
            const defaults = {
                'BTC': 92500, 'ETH': 3350, 'CRO': 0.15, 'SOL': 145,
                'BNB': 620, 'ADA': 0.85, 'PEPE': 0.000015
            };
            
            return latestPrice || defaults[latestToken] || 1000;
        }

        // Update logs
        async function updateLogs() {
            try {
                const response = await fetch(`${API_URL}/logs`);
                const logs = await response.json();

                if (logs.length === 0) return;

                const currentToken = extractTokenFromLogs(logs);
                if (currentToken !== latestToken) {
                    latestToken = currentToken;
                    latestPrice = null;
                }

                const paidLogs = logs.filter(l => l.type === 'PAID');
                totalAnalyses = paidLogs.length;
                const totalRevenue = (totalAnalyses * 0.01).toFixed(2);

                document.getElementById('total-analyses').textContent = totalAnalyses;
                document.getElementById('total-revenue').textContent = `${totalRevenue} USDC`;

                const logsHTML = logs.slice(0, 20).map(log => {
                    let typeColor = '';
                    if (log.type === 'PAID') typeColor = 'color: var(--neon-green)';
                    else if (log.type === 'ERROR') typeColor = 'color: var(--neon-pink)';
                    else if (log.type === 'AI') typeColor = 'color: var(--neon-purple)';
                    else if (log.type === 'DATA') typeColor = 'color: var(--neon-cyan)';
                    else if (log.type === 'VERIFY') typeColor = 'color: var(--neon-yellow)';
                    else typeColor = 'color: var(--text-gray)';

                    return `
                        <div class="log-entry ${log.type}">
                            <div class="log-header">
                                <span class="log-type" style="${typeColor}">[${log.type}]</span>
                                <span class="log-time">${log.time}</span>
                            </div>
                            <div class="log-message">
                                ${log.message}
                                <span style="color: #666; font-size: 10px; margin-left: 10px;">
                                    ‚Ä¢ Agent: ${log.agent.substring(0, 12)}...
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('logs').innerHTML = logsHTML;

                const aiLog = logs.find(l => l.type === 'AI' && l.message.includes('agreement'));
                
                if (aiLog && paidLogs.length > 0) {
                    document.getElementById('waiting-panel').style.display = 'none';
                    document.getElementById('consensus-panel').style.display = 'block';
                    document.getElementById('consensus-token').textContent = latestToken;
                    
                    const match = aiLog.message.match(/(\w+)\s*\((\d+)% agreement(?:,\s*(\d+)\s*rounds)?/);
                    if (match) {
                        const signal = match[1];
                        const agreement = match[2];
                        const rounds = match[3] || '2';
                        
                        updateConsensusDisplay(signal, agreement, rounds);
                    }

                    const price = extractPriceFromLogs(logs);
                    latestPrice = price;
                    updateMarketData(price, latestToken);
                }

            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        function updateConsensusDisplay(signal, agreement, rounds) {
            const signalEl = document.getElementById('consensus-signal');
            signalEl.textContent = signal;
            signalEl.className = `consensus-signal signal-${signal}`;
            
            document.getElementById('consensus-agreement').textContent = `${agreement}%`;
            document.getElementById('consensus-confidence').textContent = '72%';
            document.getElementById('consensus-rounds').textContent = rounds;
            
            let shortSummary = '';
            if (signal === 'BUY') {
                shortSummary = `Strong bullish consensus on ${latestToken}`;
            } else if (signal === 'SELL') {
                shortSummary = `Bearish pressure detected on ${latestToken}`;
            } else {
                shortSummary = `Neutral outlook, consolidation expected`;
            }
            document.getElementById('consensus-summary').textContent = shortSummary;
            
            let summaryText = '';
            if (signal === 'BUY') {
                summaryText = `After ${rounds} rounds of AI deliberation, our council recommends a BUY position on ${latestToken}. Market conditions show bullish momentum with strong technical indicators supporting upward movement.`;
            } else if (signal === 'SELL') {
                summaryText = `Following ${rounds} rounds of analysis, the AI consensus suggests a SELL signal for ${latestToken}. Multiple models detected bearish patterns and recommend reducing exposure at current levels.`;
            } else {
                summaryText = `Through ${rounds} rounds of multi-AI analysis, the consensus advises HOLDING ${latestToken}. Market conditions remain neutral with mixed signals - awaiting clearer directional movement before taking action.`;
            }
            
            document.getElementById('analysis-text').textContent = summaryText;
            
            const aiModelsHTML = `
                <div class="ai-model">
                    <div class="ai-model-header">
                        <span class="ai-model-name">üß† Llama 3.3 70B Strategist</span>
                        <span class="ai-model-badge">Deep Analysis</span>
                    </div>
                    <div class="ai-model-signal">
                        <span class="signal-indicator ${signal}">${signal}</span>
                        <span style="font-size: 12px; color: var(--text-gray);">Long-term Perspective</span>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: 75%"></div>
                    </div>
                    <div class="ai-model-reason">
                        Strategic fundamentals ${signal === 'BUY' ? 'support accumulation' : signal === 'SELL' ? 'suggest distribution' : 'indicate consolidation'} at current ${latestToken} levels.
                    </div>
                </div>

                <div class="ai-model">
                    <div class="ai-model-header">
                        <span class="ai-model-name">‚ö° Llama 3.1 8B Tactician</span>
                        <span class="ai-model-badge">Rapid Assessment</span>
                    </div>
                    <div class="ai-model-signal">
                        <span class="signal-indicator ${signal}">${signal}</span>
                        <span style="font-size: 12px; color: var(--text-gray);">Short-term Perspective</span>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: 70%"></div>
                    </div>
                    <div class="ai-model-reason">
                        Technical patterns confirm ${signal} signal with ${signal === 'BUY' ? 'bullish' : signal === 'SELL' ? 'bearish' : 'neutral'} momentum in ${latestToken} price action.
                    </div>
                </div>
            `;
            
            document.getElementById('ai-models').innerHTML = aiModelsHTML;
        }

        function updateMarketData(price, token) {
            if (!price || isNaN(price)) return;

            const formattedPrice = price.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('market-price').textContent = `$${formattedPrice}`;
            
            let changeRange = 3;
            if (token === 'BTC') changeRange = 2;
            else if (token === 'ETH') changeRange = 3;
            else if (token === 'PEPE' || token === 'DOGE') changeRange = 8;
            
            const changePercent = ((Math.random() * changeRange * 2) - changeRange).toFixed(2);
            const changeEl = document.getElementById('change-value');
            changeEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent}%`;
            changeEl.className = `price-change ${parseFloat(changePercent) >= 0 ? 'positive' : 'negative'}`;
            
            let volume;
            if (token === 'BTC') {
                volume = Math.floor(Math.random() * 20000000000 + 35000000000);
            } else if (token === 'ETH') {
                volume = Math.floor(Math.random() * 10000000000 + 18000000000);
            } else if (token === 'CRO') {
                volume = Math.floor(Math.random() * 200000000 + 300000000);
            } else {
                volume = Math.floor(Math.random() * 5000000000 + 5000000000);
            }
            
            const formattedVolume = volume.toLocaleString('en-US');
            document.getElementById('market-volume').textContent = `$${formattedVolume}`;
        }

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                if (chainId !== CRONOS_TESTNET_CHAIN_ID) {
                    switchToCronosTestnet();
                }
            });
        }

        // Auto-refresh logs
        setInterval(updateLogs, 2000);
        updateLogs();
    </script>
</body>
</html>